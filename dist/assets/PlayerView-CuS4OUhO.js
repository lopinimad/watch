import{I as M,aa as C,q as I,B as R,j as e,D as $,r as h,K as G,ak as T}from"./vendor-BWxiYVu1.js";import{e as W,i as V,g as _,f as K,s as q,c as v,d as Y,h as z,M as H,E as y,j as P,k as w,a as S,b as E,P as N,B as u,l as B,L as J,m as L,u as Q,n as X,o as Z,p as ee,q as ae,r as te,t as se,v as re,w as ne,x as ie,y as oe,z as le,A as b,C as de,D as ce,F as me,S as pe,G as ue}from"./index-Bhg6ALQw.js";function he(r,a){return!!L().DISALLOWED_IDS.map(n=>n.split("-")).find(n=>r===n[1]&&a===n[0])}function xe(r){const{t:a}=M(),t=C(),n=I(),{error:i,value:o,loading:x}=R(async()=>{var D;const l=await W(),f=(l==null?void 0:l.success)&&V(l.version)&&l.allowed;if(f&&!l.hasPermission)throw new Error("extension-no-permission");const d=_();if(d&&!f)try{await K(d)}catch{throw new Error("failed-api-metadata")}else q([...v().listSources(),...v().listEmbeds()]);let p=null;try{if(!t.media)throw new Error("no media params");p=Y(t.media)}catch{}if(!p)return null;if(he(p.id,p.type))throw new Error("dmca");let s=null;try{s=await z(p.type,p.id,t.season)}catch(m){if(m.status===404)return null;throw m}if(!s)return null;let g=t.episode;if(s.meta.type===H.SERIES){let m=s.meta.seasonData.episodes.find(A=>A.id===t.episode);m||(m=s.meta.seasonData.episodes[0]),g=m.id,(t.season!==s.meta.seasonData.id||t.episode!==m.id)&&n(`/media/${t.media}/${s.meta.seasonData.id}/${m.id}`,{replace:!0})}(D=r.onGetMeta)==null||D.call(r,s,g)},[]);return i&&i.message==="extension-no-permission"?e.jsx(y,{children:e.jsxs(P,{children:[e.jsx(w,{icon:S.WAND,children:a("player.metadata.extensionPermission.badge")}),e.jsx(E,{children:a("player.metadata.extensionPermission.title")}),e.jsx(N,{children:a("player.metadata.extensionPermission.text")}),e.jsx(u,{onClick:()=>{B({page:"PermissionGrant",redirectUrl:window.location.href})},theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.metadata.extensionPermission.button")})]})}):i&&i.message==="dmca"?e.jsx(y,{children:e.jsxs(P,{children:[e.jsx(w,{icon:S.DRAGON,children:a("player.metadata.dmca.badge")}),e.jsx(E,{children:a("player.metadata.dmca.title")}),e.jsx(N,{children:a("player.metadata.dmca.text")}),e.jsx(u,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.metadata.failed.homeButton")})]})}):i&&i.message==="failed-api-metadata"?e.jsx(y,{children:e.jsxs(P,{children:[e.jsx(w,{icon:S.WAND,children:a("player.metadata.failed.badge")}),e.jsx(E,{children:a("player.metadata.api.text")}),e.jsx(N,{children:a("player.metadata.api.title")}),e.jsx(u,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.metadata.failed.homeButton")})]})}):i?e.jsx(y,{children:e.jsxs(P,{children:[e.jsx(w,{icon:S.WAND,children:a("player.metadata.failed.badge")}),e.jsx(E,{children:a("player.metadata.failed.title")}),e.jsx(N,{children:a("player.metadata.failed.text")}),e.jsx(u,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.metadata.failed.homeButton")})]})}):!o&&!x?e.jsx(y,{children:e.jsxs(P,{children:[e.jsx(w,{icon:S.WAND,children:a("player.metadata.notFound.badge")}),e.jsx(E,{children:a("player.metadata.notFound.title")}),e.jsx(N,{children:a("player.metadata.notFound.text")}),e.jsx(u,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.metadata.notFound.homeButton")})]})}):e.jsx(y,{children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(J,{})})})}function fe(r){const{t:a}=M(),t=Q("error"),n=$(),[i,o]=h.useState("unknown"),x=I(),l=h.useMemo(()=>{const f=r.data;let d="";const p=X();return d+=`URL - ${n.pathname}
`,d+=`API - ${p.length>0}

`,Object.values(f.sources).forEach(s=>{var g;d+=`${s.id}: ${s.status}
`,s.reason&&(d+=`${s.reason}
`),(g=s.error)!=null&&g.message?d+=`${s.error.name??"unknown"}: ${s.error.message}
`:s.error&&(d+=`${s.error.toString()}
`)}),d},[r,n]);return h.useEffect(()=>{Z().then(f=>{o(f)})},[a]),i==="disallowed"?e.jsx(y,{children:e.jsxs(P,{children:[e.jsx(w,{icon:S.LOCK,children:a("player.scraping.extensionFailure.badge")}),e.jsx(E,{children:a("player.scraping.extensionFailure.title")}),e.jsx(N,{children:e.jsx(G,{i18nKey:"player.scraping.extensionFailure.text",components:{bold:e.jsx("span",{className:"font-bold",style:{color:"#cfcfcf"}})}})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(u,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.scraping.extensionFailure.homeButton")}),e.jsx(u,{onClick:()=>{B({page:"PermissionGrant",redirectUrl:window.location.href})},theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.scraping.extensionFailure.enableExtension")})]})]})}):e.jsxs(y,{children:[e.jsxs(P,{children:[e.jsx(w,{icon:S.WAND,children:a("player.scraping.notFound.badge")}),e.jsx(E,{children:a("player.scraping.notFound.title")}),e.jsx(N,{children:a("player.scraping.notFound.text")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(u,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.scraping.notFound.homeButton")}),e.jsx(u,{onClick:()=>x("/discover"),theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.scraping.notFound.discoverButton")})]}),e.jsx(u,{onClick:()=>t.show(),theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:a("player.scraping.notFound.detailsButton")})]}),l?e.jsx(ee,{id:t.id,onClose:()=>t.hide(),error:l}):null]})}async function ge(){return!(!L().HAS_ONBOARDING||await ae()||te.getState().proxySet||se.getState().completed)}function ye(r){const a=r??"";if(!!!a.match(/^\d+(:\d+)*$/))return null;const n=a.split(":").map(Number).reverse(),i=n[2]??0,o=Math.min(n[1]??0,59),x=Math.min(n[0]??0,o>0?59:1/0);return i*60*60+o*60+x}function je(){const r=I(),a=C(),[t,n]=h.useState(null),[i]=re("t"),{status:o,playMedia:x,reset:l,setScrapeNotFound:f,shouldStartFromBeginning:d,setShouldStartFromBeginning:p}=ne(),{setPlayerMeta:s,scrapeMedia:g}=ie(),D=oe(),m=le("settings"),A=h.useRef(!1),k=JSON.stringify({media:a.media,season:a.season,episode:a.episode});h.useEffect(()=>{l(),A.current=!1},[k,l]),h.useEffect(()=>{A.current||o===b.PLAYING&&new URLSearchParams(window.location.search).has("watchparty")&&setTimeout(()=>{m.navigate("/watchparty"),A.current=!0},1e3)},[o,m]);const O=h.useCallback(c=>{var j,F;(c==null?void 0:c.type)==="show"?r(`/media/${a.media}/${(j=c.season)==null?void 0:j.tmdbId}/${(F=c.episode)==null?void 0:F.tmdbId}`):r(`/media/${a.media}`)},[r,a]),U=h.useCallback(c=>{if(!c)return;let j;i&&(j=ye(i)??void 0),x(de(c),ce(c.stream.captions),c.sourceId,d?0:j),p(!1)},[x,i,d,p]);return e.jsxs(me,{backUrl:D,onMetaChange:O,children:[o===b.IDLE?e.jsx(xe,{onGetMeta:s}):null,o===b.SCRAPING&&g?e.jsx(pe,{media:g,onResult:(c,j)=>{n({sourceOrder:j,sources:c}),f()},onGetStream:U}):null,o===b.SCRAPE_NOT_FOUND&&t?e.jsx(fe,{data:t}):null,o===b.PLAYBACK_ERROR?e.jsx(ue,{}):null]})}function Se(){const r=$(),{loading:a,error:t,value:n}=R(()=>ge());if(t)throw new Error("Failed to detect onboarding");return a?null:n?e.jsx(T,{replace:!0,to:{pathname:"/onboarding",search:`redirect=${encodeURIComponent(r.pathname)}`}}):e.jsx(je,{})}export{Se as PlayerView,je as RealPlayerView,Se as default};
//# sourceMappingURL=PlayerView-CuS4OUhO.js.map
